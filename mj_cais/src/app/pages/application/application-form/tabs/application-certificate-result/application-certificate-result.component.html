<ng-container *ngIf="this.model">
  <ng-container
    *ngIf="
      this.model.statusCode ==
        CertificateStatuTypeEnum.CertificateContentReady ||
      this.model.statusCode == CertificateStatuTypeEnum.CertificatePaperPrint ||
      this.model.statusCode == CertificateStatuTypeEnum.CertificateUserSign ||
      this.model.statusCode ==
        CertificateStatuTypeEnum.CertificateForDelivery ||
      this.model.statusCode == CertificateStatuTypeEnum.Delivered
    "
  >
    <form autocomplete="off">
      <div class="row" style="align-items: center">
        <div class="form-group col-md-6">
          <cais-autocomplete
            [label]="'Подписващ1'"
            [inputFormControl]="fullForm.firstSignerId"
            [parentGroup]="fullForm.group"
            [inputName]="'firstSignerId'"
            [items]="users"
          >
          </cais-autocomplete>
        </div>
        <div class="form-group col-md-6" style="padding-right: 50px">
          <button
            *ngIf="
              !this.isForPreview &&
              this.model.statusCode ==
                CertificateStatuTypeEnum.CertificateContentReady
            "
            nbButton
            [status]="'primary'"
            (click)="generateCertificate()"
            type="button"
            style="float: right"
          >
            Генерирай свидетелство
          </button>

          <button
            *ngIf="
              this.model.statusCode ==
              CertificateStatuTypeEnum.CertificatePaperPrint
            "
            nbButton
            [status]="'primary'"
            (click)="deliver()"
            type="button"
            style="float: right"
          >
            Връчи
          </button>
          <button
            *ngIf="this.model.statusCode != CertificateStatuTypeEnum.Delivered"
            nbButton
            matRipple
            [status]="'danger'"
            (click)="cancelCertificate()"
            type="button"
          >
            <nb-icon class="pt-1" [icon]="'xmark'" pack="fa"></nb-icon> Анулирай
          </button>
          <button
            *ngIf="
              this.model.statusCode ==
              CertificateStatuTypeEnum.CertificateUserSign
            "
            nbButton
            matRipple
            [status]="'success'"
            (click)="updateStatus()"
            type="button"
            class="ml-2"
            style="min-width: 100px; float: right"
          >
            Готово за връчване
          </button>
          <!-- <button
            *ngIf="
              this.model.statusCode ==
                CertificateStatuTypeEnum.CertificatePaperPrint ||
              this.model.statusCode ==
                CertificateStatuTypeEnum.CertificateUserSign
            "
            nbButton
            matRipple
            [status]="'success'"
            (click)="printCertificate()"
            type="button"
            class="ml-2"
            style="min-width: 100px; float: right"
          >
            Свали свидетелство
          </button> -->
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-6">
          <cais-autocomplete
            [label]="'Подписващ2'"
            [inputFormControl]="fullForm.secondSignerId"
            [parentGroup]="fullForm.group"
            [inputName]="'secondSignerId'"
            [items]="users"
          >
          </cais-autocomplete>
          <cais-input
            [type]="'text'"
            [label]="'Номер на свидетелство'"
            [inputFormControl]="fullForm.registrationNumber"
            [parentGroup]="fullForm.group"
          ></cais-input>
          <cais-input
            [type]="'text'"
            [label]="'Статус'"
            [inputFormControl]="fullForm.statusName"
            [parentGroup]="fullForm.group"
          ></cais-input>

          <br />
          <a
            *ngIf="
              (this.model.statusCode ==
                CertificateStatuTypeEnum.CertificatePaperPrint ||
                this.model.statusCode ==
                  CertificateStatuTypeEnum.CertificateUserSign ||
                this.model.statusCode == CertificateStatuTypeEnum.Delivered ||
                this.model.statusCode ==
                  CertificateStatuTypeEnum.CertificateContentReady) &&
              this.fullForm.docName.value !== null
            "
            [title]="'Свали'"
            class="mr-4"
            (click)="printCertificate()"
          >
            {{ fullForm.docName.value }}.{{ fullForm.docType.value }}
          </a>

          <a
            *ngIf="
              this.model.statusCode ==
              CertificateStatuTypeEnum.CertificateUserSign
            "
            [title]="'Качи'"
            (click)="upload()"
          >
            <i class="fas fa-upload"></i>
          </a>
        </div>
      </div>
    </form>
  </ng-container>

  <ng-container
    *ngIf="this.model.statusCode == CertificateStatuTypeEnum.BulletinsCheck"
  >
    <tl-linear-progress
      [visible]="this.remoteService?.isLoading"
    ></tl-linear-progress>
    <igx-grid
      #bulletinsCheckGrid
      [height]="null"
      [data]="bulletinsCheckData"
      [primaryKey]="'id'"
      [allowFiltering]="true"
      [rowSelectable]="true"
      [rowSelection]="isForPreview ? 'none' : 'multiple'"
      [hideRowSelectors]="false"
    >
      <igx-grid-toolbar>
        <igx-grid-toolbar-title>
          <span class="fw-bold">Свидетелство</span></igx-grid-toolbar-title
        >
        <igx-grid-toolbar-actions>
          <div class="d-flex gap-2">
            <button
              *ngIf="!this.isForPreview"
              nbButton
              [status]="'primary'"
              (click)="showReport()"
              type="button"
            >
              Е-Справка
            </button>
            <!-- <button
            nbButton
            [status]="'primary'"
            (click)="previewBulletions()"
            type="button"
          >
            Преглед бюлетини
          </button> -->
            <button
              *ngIf="!this.isForPreview"
              nbButton
              [status]="'primary'"
              (click)="sendBulltinsForRehabilitation()"
              type="button"
            >
              Създай заявка за реабилитация
            </button>
            <button
              *ngIf="!this.isForPreview"
              nbButton
              [status]="'primary'"
              (click)="sendBulltinsForSelection()"
              type="button"
            >
              Изпрати за избор на бюл. от съдия/юрист
            </button>
            <igx-grid-toolbar-hiding class="mt-1"></igx-grid-toolbar-hiding>
          </div>
        </igx-grid-toolbar-actions>
      </igx-grid-toolbar>

      <igx-column
        field="id"
        header="Идентификатор"
        [sortable]="false"
        [dataType]="'string'"
        [hidden]="true"
      >
      </igx-column>

      <igx-column
        field="registrationNumber"
        header="Номер"
        [dataType]="'string'"
        [sortable]="true"
      >
      </igx-column>

      <!-- <igx-column
        field="bulletinReceivedDate"
        [sortable]="true"
        header="Дата на регистрация"
        dataType="Date"
        [formatter]="this.dateFormatService.formatDate"
      >
        <ng-template igxCell let-cell="cell">
          <span [title]="this.dateFormatService.displayDate(cell.value)">
            {{ this.dateFormatService.displayDate(cell.value) }}
          </span>
        </ng-template>
      </igx-column> -->
      <igx-column
        field="statusId"
        header="Идентификатор на статус"
        [hidden]="true"
        [dataType]="'string'"
      ></igx-column>
      <igx-column
        field="statusName"
        header="Статус"
        [sortable]="true"
        [dataType]="'string'"
      ></igx-column>

      <igx-column
        field="bulletinAuthorityId"
        header="Идентификатор на съда"
        [hidden]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinDecisionNumber"
        header="Номер решение"
        [sortable]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinTypeName"
        header="Тип на бюлетина"
        [sortable]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinDecisionDate"
        header="Дата решение"
        [sortable]="true"
        [dataType]="'date'"
      ></igx-column>
      <igx-column
        field="bulletinAuthorityName"
        header="Съд, изготвил бюлетина"
        [sortable]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        width="120px"
        header="Действия"
        [sortable]="false"
        [filterable]="false"
        [pinned]="false"
        [disableHiding]="true"
      >
        <ng-template igxCell let-cell="cell">
          <div class="cell-center">
            <div class="d-flex gap-3">
              <a
                style="color: black"
                [title]="'Преглед'"
                [routerLink]="[
                  '/pages/bulletins/preview/',
                  cell.rowData.bulletinId
                ]"
              >
                <nb-icon pack="fa" icon="eye"></nb-icon>
              </a>
              <a
                *ngIf="
                  model.currentUserAuthId == cell.rowData.bulletinAuthorityId
                "
                style="color: black"
                [title]="'Редактиране'"
                [routerLink]="[
                  '/pages/bulletins/edit/',
                  cell.rowData.bulletinId
                ]"
              >
                <nb-icon pack="fa" icon="pen"></nb-icon>
              </a>
            </div>
          </div>
        </ng-template>
      </igx-column>
    </igx-grid>
  </ng-container>

  <ng-container
    *ngIf="this.model.statusCode == CertificateStatuTypeEnum.BulletinsSelection"
  >
    <igx-grid
      #bulletinsCheckGrid
      [height]="null"
      [data]="bulletinsCheckData"
      [primaryKey]="'id'"
      [allowFiltering]="true"
      [rowSelectable]="true"
      [rowSelection]="isForPreview ? 'none' : 'multiple'"
      [hideRowSelectors]="false"
    >
      <igx-grid-toolbar>
        <igx-grid-toolbar-title>
          <span class="fw-bold">Свидетелство</span></igx-grid-toolbar-title
        >
        <igx-grid-toolbar-actions>
          <button
            *ngIf="!this.isForPreview"
            nbButton
            [status]="'primary'"
            (click)="showReport()"
            type="button"
          >
            Е-Справка
          </button>
          <div class="d-flex gap-2">
            <igx-grid-toolbar-hiding class="mt-1"></igx-grid-toolbar-hiding>
          </div>
        </igx-grid-toolbar-actions>
      </igx-grid-toolbar>

      <igx-column
        field="id"
        header="Идентификатор"
        [sortable]="false"
        [dataType]="'string'"
        [hidden]="true"
      >
      </igx-column>

      <igx-column
        field="registrationNumber"
        header="Номер"
        [dataType]="'string'"
        [sortable]="true"
      >
      </igx-column>

      <!-- <igx-column
        field="bulletinReceivedDate"
        [sortable]="true"
        header="Дата на регистрация"
        dataType="Date"
        [formatter]="this.dateFormatService.formatDate"
      >
        <ng-template igxCell let-cell="cell">
          <span [title]="this.dateFormatService.displayDate(cell.value)">
            {{ this.dateFormatService.displayDate(cell.value) }}
          </span>
        </ng-template>
      </igx-column> -->
      <igx-column
        field="statusId"
        header="Идентификатор на статус"
        [hidden]="true"
        [dataType]="'string'"
      ></igx-column>
      <igx-column
        field="statusName"
        header="Статус"
        [sortable]="true"
        [dataType]="'string'"
      ></igx-column>

      <igx-column
        field="bulletinAuthorityId"
        header="Идентификатор на съда"
        [hidden]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinAuthorityName"
        header="Съд, изготвил бюлетина"
        [sortable]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinDecisionNumber"
        header="Номер решение"
        [sortable]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinTypeName"
        header="Тип на бюлетина"
        [sortable]="true"
        [dataType]="'string'"
      >
      </igx-column>
      <igx-column
        field="bulletinDecisionDate"
        header="Дата решение"
        [sortable]="true"
        [dataType]="'date'"
      ></igx-column>
      <igx-column
        width="120px"
        header="Действия"
        [sortable]="false"
        [filterable]="false"
        [pinned]="false"
        [disableHiding]="true"
      >
        <ng-template igxCell let-cell="cell">
          <div class="cell-center">
            <div class="d-flex gap-3">
              <a
                style="color: black"
                [title]="'Преглед'"
                [routerLink]="[
                  '/pages/bulletins/preview/',
                  cell.rowData.bulletinId
                ]"
              >
                <nb-icon pack="fa" icon="eye"></nb-icon>
              </a>
              <a
                *ngIf="
                  model.currentUserAuthId == cell.rowData.bulletinAuthorityId
                "
                style="color: black"
                [title]="'Редактиране'"
                [routerLink]="[
                  '/pages/bulletins/edit/',
                  cell.rowData.bulletinId
                ]"
              >
                <nb-icon pack="fa" icon="pen"></nb-icon>
              </a>
            </div>
          </div>
        </ng-template>
      </igx-column>
    </igx-grid>

    <form autocomplete="off" class="mt-2">
      <div class="row" style="align-items: center">
        <div class="form-group col-md-6">
          <cais-autocomplete
            [label]="'Подписващ1'"
            [inputFormControl]="fullForm.firstSignerId"
            [parentGroup]="fullForm.group"
            [inputName]="'firstSignerId'"
            [items]="users"
          >
          </cais-autocomplete>
        </div>
        <div class="form-group col-md-6" style="padding-right: 50px">
          <button
            *ngIf="!this.isForPreview"
            nbButton
            [status]="'primary'"
            (click)="generateCertificateByJudge()"
            type="button"
            style="min-width: 100px; float: right"
          >
            Генерирай свидетелство
          </button>
          <button
            *ngIf="
              this.model.statusCode ==
              CertificateStatuTypeEnum.CertificateUserSign
            "
            nbButton
            [status]="'success'"
            (click)="updateStatus()"
            type="button"
            style="min-width: 100px; float: right"
          >
            Готово за връчване
          </button>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-6">
          <cais-autocomplete
            [label]="'Подписващ2'"
            [inputFormControl]="fullForm.secondSignerId"
            [parentGroup]="fullForm.group"
            [inputName]="'secondSignerId'"
            [items]="users"
          >
          </cais-autocomplete>
          <cais-input
            [type]="'text'"
            [label]="'Номер на свидетелство'"
            [inputFormControl]="fullForm.registrationNumber"
            [parentGroup]="fullForm.group"
          ></cais-input>
          <cais-input
            [type]="'text'"
            [label]="'Статус'"
            [inputFormControl]="fullForm.statusName"
            [parentGroup]="fullForm.group"
          ></cais-input>

          <br />
          <a
            *ngIf="
              (this.model.statusCode ==
                CertificateStatuTypeEnum.CertificatePaperPrint ||
                this.model.statusCode ==
                  CertificateStatuTypeEnum.CertificateUserSign ||
                this.model.statusCode == CertificateStatuTypeEnum.Delivered ||
                this.model.statusCode ==
                  CertificateStatuTypeEnum.CertificateContentReady) &&
              this.fullForm.docName.value !== null
            "
            [title]="'Свали'"
            class="mr-4"
            (click)="printCertificate()"
          >
            {{ fullForm.docName.value }}.{{ fullForm.docType.value }}
          </a>

          <a
            *ngIf="
              this.model.statusCode ==
              CertificateStatuTypeEnum.CertificateUserSign
            "
            [title]="'Качи'"
            (click)="upload()"
          >
            <i class="fas fa-upload"></i>
          </a>
        </div>
      </div>
    </form>
  </ng-container>
</ng-container>

<igx-dialog #reportDialog>
  <div style="min-width: 1000px">
    <nb-card>
      <nb-card-header>
        <div class="d-flex" style="justify-content: space-between">
          <h5 style="font-weight: bold">Справка</h5>
          <div>
            <button
              nbButton
              matRipple
              [status]="'success'"
              (click)="onPrint()"
              type="button"
              class="ml-2"
            >
              <nb-icon pack="fa" icon="print"></nb-icon> Принтирай
            </button>
            <button
              nbButton
              matRipple
              (click)="reportDialog.close()"
              type="button"
              class="ml-2"
            >
              Затвори
            </button>
          </div>
        </div>
      </nb-card-header>
      <nb-card-body>
        <cais-encapsulated-html [Html]="this.report"> </cais-encapsulated-html>
      </nb-card-body>
    </nb-card>
  </div>
</igx-dialog>
